<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>United Flight Attendant Pay Calculator</title>
    <meta name="description" content="Easily calculate United FA trip pay — including purser, galley, holiday, flag, language, and more. Works on desktop & mobile.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kimbofox.github.io/flight-attendant-pay-calculator/">
    <meta property="og:title" content="United Flight Attendant Pay Calculator">
    <meta property="og:description" content="Easily calculate United FA trip pay — including purser, galley, holiday, flag, language, and more. Works on desktop & mobile.">
    <meta property="og:image" content="https://kimbofox.github.io/flight-attendant-pay-calculator/images/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kimbofox.github.io/flight-attendant-pay-calculator/">
    <meta property="twitter:title" content="United Flight Attendant Pay Calculator">
    <meta property="twitter:description" content="Easily calculate United FA trip pay — including purser, galley, holiday, flag, language, and more. Works on desktop & mobile.">
    <meta property="twitter:image" content="https://kimbofox.github.io/flight-attendant-pay-calculator/images/og-image.jpg">
    <style>
        :root {
            --primary: #3a36e0;
            --primary-light: #6d6aff;
            --primary-dark: #2d2ca9;
            --secondary: #ff9d00;
            --secondary-light: #ffb240;
            --secondary-dark: #e58900;
            --success: #00c48c;
            --danger: #ff647c;
            --warning: #ffd166;
            --info: #0084ff;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1a202c;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
            --shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
            --header-height: 64px;
            --side-panel-width: 320px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #121620;
                --surface: #1a202c;
                --text: #ffffff;
                --text-secondary: #cbd5e0;
                --border: #4a5568;
                --primary: #818cf8;
                --primary-light: #a5b4fc;
                --primary-dark: #6366f1;
                --secondary: #ffb74d;
                --secondary-light: #ffcc80;
                --secondary-dark: #ff9800;
                --success: #4ade80;
                --danger: #f87171;
                --warning: #fcd34d;
                --info: #60a5fa;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        html, body {
            min-height: 100%;
            background-color: var(--background);
            color: var(--text);
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            position: fixed !important;
            z-index: 2147483647 !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            background: var(--surface) !important;
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            height: var(--header-height);
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
        }
        
        @media (max-width: 480px) {
            .header {
                min-height: 64px;
                padding: 12px 16px;
            }
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .app-logo {
            width: 36px;
            height: 36px;
            background-color: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Main content */
        .main-content {
            display: flex;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        /* Trip comparison container */
        .trip-comparison {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            min-height: 0;
        }

        .no-trips-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 0 20px;
        }

        .no-trips-message h2 {
            margin-bottom: 16px;
            font-weight: 600;
        }

        .no-trips-message p {
            margin-bottom: 24px;
            max-width: 600px;
        }

        /* Add Trip Panel */
        .side-panel {
            position: absolute;
            top: 0;                         /* start at the very top of .main-content */
            bottom: 0;                      /* stretch to the bottom of .main-content */
            right: 0;
            width: var(--side-panel-width);
            background-color: var(--surface);
            border-left: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 5;
        }

        .side-panel.collapsed {
            transform: translateX(100%);
        }

        .side-panel h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--border);
            transition: var(--transition);
            border: none;
            padding: 0;
            font-size: 16px;
            color: var(--text);
            font-weight: 600;
        }
        
        @media (max-width: 480px) {
            .panel-close {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
        }

        .panel-close:hover {
            background-color: var(--text-secondary);
            color: var(--surface);
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }
        
        @media (max-width: 480px) {
            .form-group {
                margin-bottom: 12px;
            }
            
            label {
                margin-bottom: 4px;
                font-size: 0.85rem;
            }
            
            /* Override already updated in the new media query for form-control */
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        @media (prefers-color-scheme: dark) {
            label {
                color: var(--text);
            }
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--surface);
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
            min-height: 44px;
        }
        
        @media (max-width: 480px) {
            .form-control {
                padding: 14px 16px;
                min-height: 48px;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .validation-message {
            font-size: 0.8rem;
            color: var(--danger);
            margin-top: 4px;
            display: none;
            padding: 4px 8px;
            border-left: 2px solid var(--danger);
            background-color: rgba(255, 100, 124, 0.1);
            font-weight: 500;
        }
        
        @media (prefers-color-scheme: dark) {
            .validation-message {
                background-color: rgba(248, 113, 113, 0.2);
                color: #f87171;
                border-left-color: #f87171;
            }
        }

        /* Style for inputs with errors */
        input[aria-invalid="true"], 
        select[aria-invalid="true"] {
            border-color: var(--danger);
            box-shadow: 0 0 0 1px var(--danger);
        }
        
        @media (prefers-color-scheme: dark) {
            .form-control {
                background-color: #1a202c;
                border-color: #4a5568;
                color: #ffffff;
            }
            
            .form-control:focus {
                border-color: var(--primary-light);
                box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
            }
        }

        /* Focus indicator for better accessibility */
        input:focus,
        select:focus,
        button:focus,
        [role="button"]:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* High contrast focus for keyboard navigation */
        input:focus-visible,
        select:focus-visible,
        button:focus-visible,
        [role="button"]:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(58, 54, 224, 0.4);
        }
        
        @media (prefers-color-scheme: dark) {
            input:focus-visible,
            select:focus-visible,
            button:focus-visible,
            [role="button"]:focus-visible {
                outline: 3px solid var(--primary-light);
                box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.5);
            }
        }

        /* Skip navigation links */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            z-index: 2000;
            transition: top 0.3s;
            border-radius: 0 0 8px 0;
            text-decoration: none;
            box-shadow: var(--shadow);
            font-weight: 600;
            margin-right: 8px;
            display: inline-block;
        }
        
        @media (prefers-color-scheme: dark) {
            .skip-link {
                background: var(--primary-light);
                color: #000000;
                font-weight: 700;
            }
        }

        .skip-link:focus {
            top: 0;
        }
        
        .skip-link:hover {
            background: var(--primary-dark);
        }
        
        .skip-nav-container {
            position: relative;
            z-index: 2000;
        }

        .conditional-form-group {
            padding-left: 16px;
            border-left: 2px solid var(--border);
            margin-left: 4px;
            margin-bottom: 16px;
            display: none;
        }
        
        @media (prefers-color-scheme: dark) {
            .conditional-form-group {
                border-left-color: var(--primary);
            }
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        @media (max-width: 480px) {
            .toggle-switch {
                width: 70px;
                height: 34px;
            }
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(58, 54, 224, 0.4);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        @media (max-width: 480px) {
            .toggle-slider:before {
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
            }
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        @media (max-width: 480px) {
            input:checked + .toggle-slider:before {
                transform: translateX(36px);
            }
        }

        .toggle-label {
            margin-left: 8px;
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }
        
        @media (prefers-color-scheme: dark) {
            .toggle-label {
                color: var(--text);
                font-weight: 600;
            }
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            gap: 8px;
            font-size: 0.95rem;
            text-decoration: none;
            min-height: 44px;
            min-width: 44px;
        }
        
        @media (max-width: 768px) {
            .btn {
                padding: 12px 16px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                min-height: 48px;
                font-size: 1rem;
            }
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background-color: var(--border);
        }
        
        @media (prefers-color-scheme: dark) {
            .btn-outline {
                border-color: var(--primary);
                color: var(--primary-light);
            }
            
            .btn-outline:hover {
                background-color: rgba(129, 140, 248, 0.2);
            }
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #ff4560;
        }

        .btn-add-trip {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 100;
            font-size: 1.75rem;
            border: none;
            padding: 0;
            padding-bottom: 5px;
        }
        
        @media (max-width: 480px) {
            .btn-add-trip {
                width: 72px;
                height: 72px;
                font-size: 2rem;
            }
        }

        .btn-add-trip:hover {
            transform: scale(1.05);
            background-color: var(--primary-dark);
        }

        .btn-actions {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }

        .btn-block {
            width: 100%;
        }

        /* Trip card */
        .trip-card {
            min-width: 300px;
            max-width: 400px;
            width: 100%;
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            position: relative;
        }

        .trip-card.best-trip {
  box-shadow:
    0 4px 6px rgba(0,0,0,0.1),
    0 0 0 4px var(--success);
  transition: box-shadow 0.3s ease;
}

.trip-card.best-trip .trip-summary-value {
  color: var(--success) !important;
  font-weight: 700;
}

@media (prefers-color-scheme: dark) {
  .trip-card.best-trip {
    box-shadow:
      0 4px 6px rgba(0,0,0,0.2),
      0 0 0 4px var(--success);
  }
  
  .trip-card.best-trip .trip-summary-value {
    color: var(--success) !important;
  }
}

        .trip-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .trip-card-header {
            padding: 16px;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .trip-card-actions {
            display: flex;
            gap: 8px;
        }

        .trip-card-action {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            padding: 0;
            font-size: 18px;
            color: white;
        }
        
        @media (max-width: 480px) {
            .trip-card-action {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
        }

        .trip-card-action:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .trip-card-action:focus {
            outline: 2px solid white;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
        }

        .trip-card-body {
            padding: 16px;
            flex: 1;
        }

        .trip-details {
            margin-bottom: 16px;
        }

        .trip-detail {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border);
        }

        .trip-detail:last-child {
            border-bottom: none;
        }

        .trip-detail-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .trip-detail-value {
            font-weight: 500;
        }

        .trip-summary {
            background-color: rgba(99, 102, 241, 0.15);
            padding: 16px;
            border-radius: var(--radius);
            margin-top: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        @media (prefers-color-scheme: dark) {
            .trip-summary {
                background-color: rgba(129, 140, 248, 0.15);
                border-color: rgba(129, 140, 248, 0.3);
            }
        }

        .trip-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
        }

        .trip-summary-label {
            font-weight: 500;
        }

        .trip-summary-value {
            font-weight: 600;
            color: var(--secondary-dark);
        }

        .trip-summary-item.highlight {
            padding-top: 12px;
            margin-top: 8px;
            border-top: 1px solid rgba(99, 102, 241, 0.3);
        }

        .trip-summary-item.highlight .trip-summary-value {
            font-size: 1.1rem;
            color: var(--primary-dark);
        }
        
        @media (prefers-color-scheme: dark) {
            .trip-summary-item.highlight .trip-summary-value {
                color: var(--primary-light);
            }
            
            .trip-summary-value {
                color: var(--secondary-light);
            }
        }

        .best-value-badge {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--success);
    color: #000000;
    padding: 6px 16px;
    border-radius: var(--radius-lg);
    font-size: 0.9rem;
    font-weight: 700;
    box-shadow: var(--shadow-lg);
    z-index: 2;
    display: none;
    transition: var(--transition);
}

@media (prefers-color-scheme: dark) {
    .best-value-badge {
        background-color: var(--success);
        color: #000000;
        box-shadow: 0 10px 15px rgba(0,0,0,0.2), 0 4px 6px rgba(0,0,0,0.1);
    }
}


        /* Chart */
        .trip-chart {
            margin-top: 24px;
            height: 180px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 9999;
            pointer-events: none; /* Allow clicks to pass through to content below */
        }
        
        .toast {
            padding: 12px 16px;
            border-radius: var(--radius);
            background-color: var(--surface);
            box-shadow: var(--shadow);
            color: var(--text);
            font-size: 0.9rem;
            max-width: 320px;
            width: calc(100% - 24px);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease forwards;
            border-left: 4px solid var(--info);
            pointer-events: auto; /* Re-enable pointer events for the toast itself */
        }
        
        @media (max-width: 480px) {
            .toast {
                max-width: 280px;
                padding: 10px 14px;
                font-size: 0.8rem;
            }
            
            .toast-container {
                bottom: 16px;
                left: 16px;
            }
        }

        .toast-success {
            border-left-color: var(--success);
        }

        .toast-error {
            border-left-color: var(--danger);
        }

        .toast-warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Media queries */
        @media (max-width: 1024px), (hover: none) and (pointer: coarse) {
            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 2147483647;
                width: 100vw;
                background: var(--surface);
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 8px;
                min-height: auto;
                row-gap: 4px;
            }
            .header > * {
                flex: 1 1 auto;
            }
            .main-content {
                margin-top: var(--header-height);
            }
            .side-panel {
                position: fixed;
                top: var(--header-height);
                right: 0;
                height: calc(100vh - var(--header-height));
                width: 90vw;
                max-width: 400px;
                box-shadow: var(--shadow-lg);
                z-index: 999;
                left: auto;
                background: var(--surface);
            }
        }
        @media (orientation: portrait) {
            .header {
                z-index: 2147483647;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100vw;
                background: var(--surface);
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 8px;
                min-height: auto;
                row-gap: 4px;
            }
            .header > * {
                flex: 1 1 auto;
            }
            .side-panel {
                z-index: 999;
                position: fixed;
                top: var(--header-height);
                left: 0;
                right: 0;
                width: 100vw;
                max-width: 100vw;
                height: calc(100vh - var(--header-height));
                background: var(--surface);
            }
        }
        @media (orientation: landscape) and (max-width: 900px) {
            .header {
                z-index: 2147483647;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100vw;
                background: var(--surface);
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 8px;
                min-height: auto;
                row-gap: 4px;
            }
            .header > * {
                flex: 1 1 auto;
            }
            .side-panel {
                z-index: 999;
                position: fixed;
                top: var(--header-height);
                right: 0;
                left: auto;
                width: 60vw;
                max-width: 480px;
                height: calc(100vh - var(--header-height));
                background: var(--surface);
            }
        }

        /* Add to <style> section */
        .tooltip-icon {
          display: inline-block;
          margin-left: 6px;
          color: #3a36e0;
          background: #fff;
          border-radius: 50%;
          width: 1em;
          height: 1em;
          font-size: 0.9em;
          text-align: center;
          line-height: 1em;
          cursor: pointer;
          position: relative;
          border: 1px solid #3a36e0;
          font-weight: bold;
          vertical-align: middle;
        }

        .tooltip-text {
          display: none;
          position: absolute;
          left: 50%;
          top: -45px;
          transform: translateX(-50%);
          background: #222;
          color: #fff;
          padding: 2.5px 10px;
          border-radius: 6px;
          font-size: 0.85em;
          white-space: pre-line;
          z-index: 100;
          min-width: 140px;
          max-width: 260px;
          text-align: center;
          pointer-events: none;
          box-sizing: border-box;
        }

        .tooltip-icon:hover .tooltip-text,
        .tooltip-icon:focus .tooltip-text {
          display: block;
        }
    </style>
</head>
<body>
    <div class="skip-nav-container">
        <a href="#trip-comparison" class="skip-link">Skip to main content</a>
        <a href="#add-trip-btn" class="skip-link">Skip to add trip</a>
        <a href="#side-panel" class="skip-link">Skip to form panel</a>
    </div>
    <div class="app-container">
        <header class="header" id="header">
            <div class="app-title">
                <div class="app-logo">FT</div>
                <h1>Flight Trip Comparison Tool</h1>
            </div>
            <div class="header-actions">
                <button id="clear-all-btn" class="btn btn-outline" aria-label="Clear all trips">Clear All</button>
                <button id="feedback-btn" class="btn btn-outline" aria-label="Provide feedback" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSc8ATwj4UAgkAzudfzTqZFK3Bc2fe-6bJb31ojZ1Ml8okeraA/viewform?usp=header', '_blank')">Feedback</button>
                <button id="export-btn" class="btn btn-outline" aria-label="Export trips">Export</button>
            </div>
        </header>

        <div class="main-content">
            <div class="trip-comparison" id="trip-comparison" tabindex="-1">
                <div class="no-trips-message" id="no-trips-message">
                    <h2>No trips to compare yet</h2>
                    <p>Click the "+" button to add your first trip. You can add multiple trips to compare their value and find the best option.</p>
                    <button class="btn btn-primary" id="first-trip-btn" aria-label="Add your first trip">Add Your First Trip</button>
                </div>
            </div>

            <div class="side-panel collapsed" id="side-panel">
                <h2>
                    <span id="panel-title">Add New Trip</span>
                    <button class="panel-close" id="panel-close" aria-label="Close panel" type="button">✕</button>
                </h2>

                <form id="trip-form">
                    <input type="hidden" id="trip-id" value="">

                    <div class="form-group">
                        <label for="trip-name">Trip Name</label>
                        <input type="text" id="trip-name" class="form-control" placeholder="e.g., NYC 3-day" required aria-required="true">
                    </div>

                    <div class="form-group">
                        <label for="pay-year">Pay Year</label>
                        <select id="pay-year" class="form-control" required aria-required="true">
                            <option value="Year 1">Year 1</option>
                            <option value="Year 2">Year 2</option>
                            <option value="Year 3">Year 3</option>
                            <option value="Year 4">Year 4</option>
                            <option value="Year 5">Year 5</option>
                            <option value="Year 6">Year 6</option>
                            <option value="Year 7">Year 7</option>
                            <option value="Year 8">Year 8</option>
                            <option value="Year 9">Year 9</option>
                            <option value="Year 10">Year 10</option>
                            <option value="Year 11">Year 11</option>
                            <option value="Year 12">Year 12</option>
                            <option value="Year 13+">Year 13+</option>
                        </select>
                    </div>

                    <div class="form-group">
                      <label id="white-flag-label-text">White Flag</label>
                      <div class="toggle-container">
                        <label class="toggle-switch">
                          <input type="checkbox" id="white-flag">
                          <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="white-flag-label-text"></span>
                        </label>
                        <span class="toggle-label" id="white-flag-label">No</span>
                      </div>
                    </div>

                    <div class="form-group">
                      <label id="purple-flag-label-text">Purple Flag</label>
                      <div class="toggle-container">
                        <label class="toggle-switch">
                          <input type="checkbox" id="purple-flag">
                          <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="purple-flag-label-text"></span>
                        </label>
                        <span class="toggle-label" id="purple-flag-label">No</span>
                      </div>
                    </div>

                    <div class="conditional-form-group" id="purple-flag-dropdown-group" style="display:none;">
                      <div class="form-group">
                        <label for="purple-flag-premium">Purple Flag Premium</label>
                        <select id="purple-flag-premium" class="form-control">
                          <option value="1.5">150%</option>
                          <option value="2">200%</option>
                          <option value="2.5">250%</option>
                          <option value="3">300%</option>
                        </select>
                      </div>
                    </div>



                    <div class="form-group">
                        <label for="trip-length">Trip Length (Days)</label>
                        <select id="trip-length" class="form-control" required aria-required="true">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Credited Hours</label>
                        <div style="display:flex; gap:8px;">
                            <input
                            type="number"
                            id="credited-hours-hours"
                            class="form-control"
                            min="0"
                            placeholder="Hrs"
                            required
                            aria-required="true"
                        >
                        <input
                            type="number"
                            id="credited-hours-minutes"
                            class="form-control"
                            min="0" max="59" step="1"
                            placeholder="Min"
                            required
                            aria-required="true"
                        >
                    </div>
                    </div>

                    <div class="form-group">
                        <label>Purser Pay</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="purser-pay">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="purser-pay-label-text"></span>
                            </label>
                            <span class="toggle-label" id="purser-pay-label">No</span>
                        </div>
                    </div>

                    <div class="conditional-form-group" id="purser-fields-group">
                        <div class="form-group">
                            <label for="aircraft-type">Aircraft Type</label>
                            <select id="aircraft-type" class="form-control">
                                <option value="Narrow1">A319 / A320 / B737‑700</option>
                                <option value="Narrow2">B737‑800 / 900 / MAX / B‑757 / A321</option>
                                <option value="Wide">Widebody</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="purser-us-hours">Purser US Hours</label>
                            <input type="number" id="purser-us-hours" class="form-control" min="0" step="0.01" value="0" aria-describedby="purser-us-hours-validation">
                            <div class="validation-message" id="purser-us-hours-validation" role="alert" aria-live="assertive">Galley + Purser hours cannot exceed Credited Hours</div>
                        </div>

                        <div class="form-group">
                            <label for="purser-non-us-hours">Purser Non-US Hours</label>
                            <input type="number" id="purser-non-us-hours" class="form-control" min="0" step="0.01" value="0" aria-describedby="purser-non-us-hours-validation">
                            <div class="validation-message" id="purser-non-us-hours-validation" role="alert" aria-live="assertive">Galley + Purser hours cannot exceed Credited Hours</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Galley Pay</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="galley-pay">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="galley-pay-label-text"></span>
                            </label>
                            <span class="toggle-label" id="galley-pay-label">No</span>
                        </div>
                    </div>

                    <div class="conditional-form-group" id="galley-hours-group">
                        <div class="form-group">
                            <label for="galley-hours">Galley Hours</label>
                            <div style="display:flex; gap:8px;">
                                <input
                                    type="number"
                                    id="galley-hours-hours"
                                    class="form-control"
                                    min="0"
                                    placeholder="Hrs"
                                    value="0"
                                    aria-describedby="galley-hours-validation"
                                >
                                <input
                                    type="number"
                                    id="galley-hours-minutes"
                                    class="form-control"
                                    min="0" max="59" step="1"
                                    placeholder="Min"
                                    value="0"
                                    aria-describedby="galley-hours-validation"
                                >
                            </div>
                            <div class="validation-message" id="galley-hours-validation" role="alert" aria-live="assertive">Galley + Purser hours cannot exceed Credited Hours</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="intl-pay-override-label-text">International Override
                          <span class="tooltip-icon" tabindex="0">?
                            <span class="tooltip-text">Outside the continental U.S. and Canada</span>
                          </span>
                        </label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="intl-pay-override">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="intl-pay-override-label-text"></span>
                            </label>
                            <span class="toggle-label" id="intl-pay-override-label">No</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="language-pay-label-text">Language Pay</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="language-pay">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="language-pay-label-text"></span>
                            </label>
                            <span class="toggle-label" id="language-pay-label">No</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="holiday-pay-label-text">Holiday Pay</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="holiday-pay">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="holiday-pay-label-text"></span>
                            </label>
                            <span class="toggle-label" id="holiday-pay-label">No</span>
                        </div>
                    </div>

                    <div class="conditional-form-group" id="holiday-hours-group">
                      <div class="form-group">
                        <label for="holiday-hours">
                          Hours on Holiday
                          <span class="tooltip-icon" tabindex="0">?
                            <span class="tooltip-text">
                              Holiday hours = TAFB hours overlapping the holiday.
                            </span>
                          </span>
                        </label>
                        <input type="number" id="holiday-hours" name="holiday-hours" class="form-control" min="0" max="24" value="0" />
                        <div class="validation-message" id="holiday-hours-validation" role="alert" aria-live="assertive" style="display:none;">Maximum is 24 hours</div>
                        <div class="form-help-text" id="holiday-hours-example" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; line-height: 1.4;">
                          E.g., Trip: Dec 24 @ 22:00 → Dec 26 @ 14:00. Holiday (Dec 25): 24 hours.
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                        <label>TAFB Time</label>
                        <div style="display:flex; gap:8px;">
                            <input
                            type="number"
                            id="tafb-hours"
                            class="form-control"
                            min="0"
                            placeholder="Hrs"
                            required
                            aria-required="true"
                            >
                            <input
                            type="number"
                            id="tafb-minutes"
                            class="form-control"
                            min="0" max="59" step="1"
                            placeholder="Min"
                            required
                            aria-required="true"
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="intl-override-label-text">International Per Diem
                          <span class="tooltip-icon" tabindex="0">?
                            <span class="tooltip-text">Destinations outside of U.S., Canada, Mexico, Central America, Caribbean</span>
                          </span>
                        </label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="intl-override">
                                <span class="toggle-slider" tabindex="0" role="switch" aria-checked="false" aria-labelledby="intl-override-label-text"></span>
                            </label>
                            <span class="toggle-label" id="intl-override-label">No</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="retirement-percentage">Retirement % (0-100) (optional)</label>
                        <input type="number" id="retirement-percentage" class="form-control" min="0" max="100" step="1" value="0">
                    </div>

                    <div class="form-group">
                        <label for="tax-rate">Tax Rate % (0-100) (optional)</label>
                        <input type="number" id="tax-rate" class="form-control" min="0" max="100" step="1" value="0">
                    </div>

                    <div class="btn-actions">
                        <button type="button" id="cancel-btn" class="btn btn-outline btn-block" aria-label="Cancel trip editing">Cancel</button>
                        <button type="submit" id="save-trip-btn" class="btn btn-primary btn-block" aria-label="Save trip">Save Trip</button>
                    </div>
                </form>
            </div>
        </div>

        <button class="btn-add-trip" id="add-trip-btn" aria-label="Add new trip" type="button">+</button>
        <div class="toast-container" id="toast-container"></div>
    </div>

    <script>
        // Flight Trip Comparison Tool - Spec v2.1
        // A tool to compare different flight trips and their compensation
        
        // Add keyboard navigation support for skip links
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure skip links work properly by making target elements focusable
            const makeElementsFocusable = function() {
                const elementsToMakeFocusable = [
                    document.getElementById('trip-comparison'),
                    document.getElementById('add-trip-btn'),
                    document.getElementById('side-panel')
                ];
                
                elementsToMakeFocusable.forEach(el => {
                    if (el && !el.hasAttribute('tabindex')) {
                        el.setAttribute('tabindex', '-1');
                    }
                });
            };
            
            makeElementsFocusable();
        });

        // Create main application namespace
        const FlightApp = {
            // Constants
            constants: {
                DOMESTIC_PER_DIEM_RATE: 2.40,      // Domestic per diem rate: $2.40/hr (tax-free)
                INTERNATIONAL_PER_DIEM_RATE: 2.90, // International per diem rate: $2.90/hr (tax-free)
                STORAGE_KEY: 'flightTrips',
                VERSION: '2.1'
            },
            
            // Master Pay Data - pay rates by year
            masterPayData: {
                "Year 1": { baseRate: 28.88, flagRate: 43.32 },
                "Year 2": { baseRate: 30.64, flagRate: 45.96 },
                "Year 3": { baseRate: 32.59, flagRate: 48.89 },
                "Year 4": { baseRate: 34.71, flagRate: 52.07 },
                "Year 5": { baseRate: 38.25, flagRate: 57.38 },
                "Year 6": { baseRate: 43.30, flagRate: 64.95 },
                "Year 7": { baseRate: 48.41, flagRate: 72.62 },
                "Year 8": { baseRate: 49.96, flagRate: 74.94 },
                "Year 9": { baseRate: 51.34, flagRate: 77.01 },
                "Year 10": { baseRate: 53.26, flagRate: 79.89 },
                "Year 11": { baseRate: 54.73, flagRate: 82.10 },
                "Year 12": { baseRate: 57.33, flagRate: 86.00 },
                "Year 13+": { baseRate: 67.11, flagRate: 100.67 }
            },
            
            // Application state
            state: {
                trips: [],
                editingTripId: null
            },
            
            // DOM Elements - will be populated in init()
            elements: {},
            
            // Trip operations history for potential undo
            history: {
                lastOperation: null,
                lastState: null,
                
                // Save current state before modification
                saveState: function(operation, tripId) {
                    try {
                        this.lastOperation = operation;
                        this.lastState = JSON.parse(JSON.stringify(FlightApp.state.trips));
                        console.log(`Saved state before ${operation} operation on trip ${tripId}`);
                    } catch (error) {
                        console.error('Error saving history state:', error);
                    }
                },
                
                // Restore last state if needed
                undoLastOperation: function() {
                    if (!this.lastState || !this.lastOperation) {
                        FlightApp.showToast('Nothing to undo', 'info');
                        return false;
                    }
                    
                    FlightApp.state.trips = this.lastState;
                    const operation = this.lastOperation;
                    this.lastState = null;
                    this.lastOperation = null;
                    
                    FlightApp.renderTrips();
                    FlightApp.showToast(`Undid last ${operation}`, 'success');
                    return true;
                }
            },

            // Utility methods
            utils: {
                // Format currency safely
                formatCurrency: function(value) {
                    try {
                        const num = parseFloat(value);
                        if (isNaN(num) || !isFinite(num)) {
                            return '$0.00';
                        }
                        return '$' + num.toFixed(2);
                    } catch (error) {
                        console.error('Error formatting currency:', error);
                        return '$0.00';
                    }
                },
                
                // Parse hours:minutes format to decimal hours
                parseHM: function(hoursStr, minutesStr) {
                    try {
                        const hours = parseInt(hoursStr, 10) || 0;
                        const minutes = parseInt(minutesStr, 10) || 0;
                        return hours + (minutes / 60);
                    } catch (error) {
                        console.error('Error parsing hours/minutes:', error);
                        return 0;
                    }
                },
                
                // Generate a unique ID
                generateId: function() {
                    return Math.random().toString(36).substr(2, 9);
                },
                
                // Generate a random color for trip cards
                getRandomColor: function() {
                    const colors = [
                        '#3a36e0', // Primary
                        '#ff9d00', // Secondary
                        '#00c48c', // Success
                        '#0084ff', // Info
                        '#7C3AED', // Purple
                        '#0EA5E9', // Sky
                        '#F97316', // Orange
                        '#10B981', // Emerald
                        '#EC4899', // Pink
                    ];
                    
                    return colors[Math.floor(Math.random() * colors.length)];
                }
            },

            // Format currency safely
            formatCurrency: function(value) {
                try {
                    const num = parseFloat(value);
                    if (isNaN(num) || !isFinite(num)) {
                        return '$0.00';
                    }
                    return '$' + num.toFixed(2);
                } catch (error) {
                    console.error('Error formatting currency:', error);
                    return '$0.00';
                }
            },

            parseHM: function(hm) {
                const [h, m] = (hm || '00:00').split(':').map(Number);
                return h + m / 60;
            },
            
            // Generate unique ID
            generateId: function() {
                return Math.random().toString(36).substr(2, 9);
            },

            // Validate hours
            validateHours: function() {
                try {
                    // Parse and validate all inputs
                    const chH = Math.max(0, parseInt(FlightApp.elements.creditedHoursHoursInput.value, 10) || 0);
                    const chM = Math.max(0, Math.min(59, parseInt(FlightApp.elements.creditedHoursMinutesInput.value, 10) || 0));
                    const creditedHours = chH + (chM / 60);
                    
                    // Calculate total special hours
                    const galleyHoursH = FlightApp.elements.galleyPayToggle.checked ? 
                        Math.max(0, parseInt(FlightApp.elements.galleyHoursHoursInput.value, 10) || 0) : 0;
                    const galleyHoursM = FlightApp.elements.galleyPayToggle.checked ? 
                        Math.max(0, Math.min(59, parseInt(FlightApp.elements.galleyHoursMinutesInput.value, 10) || 0)) : 0;
                    const galleyHours = galleyHoursH + (galleyHoursM / 60);
                        
                    const purserUSHours = FlightApp.elements.purserPayToggle.checked ? 
                        Math.max(0, parseFloat(FlightApp.elements.purserUSHoursInput.value) || 0) : 0;
                        
                    const purserNonUSHours = FlightApp.elements.purserPayToggle.checked ? 
                        Math.max(0, parseFloat(FlightApp.elements.purserNonUSHoursInput.value) || 0) : 0;
                    
                    const totalSpecialHours = galleyHours + purserUSHours + purserNonUSHours;
                    
                    // Check if total special hours exceed credited hours
                    const isValid = totalSpecialHours <= creditedHours;

                    // Update validation messages
                    if (!isValid) {
                        const message = `Special hours (${totalSpecialHours.toFixed(2)}) exceed credited hours (${creditedHours.toFixed(2)})`;
                        
                        if (FlightApp.elements.galleyPayToggle.checked) {
                            FlightApp.elements.galleyHoursValidation.textContent = message;
                            FlightApp.elements.galleyHoursValidation.style.display = 'block';
                            FlightApp.elements.galleyHoursHoursInput.setAttribute('aria-invalid', 'true');
                            FlightApp.elements.galleyHoursMinutesInput.setAttribute('aria-invalid', 'true');
                        } else {
                            FlightApp.elements.galleyHoursValidation.style.display = 'none';
                            FlightApp.elements.galleyHoursHoursInput.removeAttribute('aria-invalid');
                            FlightApp.elements.galleyHoursMinutesInput.removeAttribute('aria-invalid');
                        }
                        
                        if (FlightApp.elements.purserPayToggle.checked) {
                            FlightApp.elements.purserUSHoursValidation.textContent = message;
                            FlightApp.elements.purserUSHoursValidation.style.display = 'block';
                            FlightApp.elements.purserNonUSHoursValidation.textContent = message;
                            FlightApp.elements.purserNonUSHoursValidation.style.display = 'block';
                            FlightApp.elements.purserUSHoursInput.setAttribute('aria-invalid', 'true');
                            FlightApp.elements.purserNonUSHoursInput.setAttribute('aria-invalid', 'true');
                        } else {
                            FlightApp.elements.purserUSHoursValidation.style.display = 'none';
                            FlightApp.elements.purserNonUSHoursValidation.style.display = 'none';
                            FlightApp.elements.purserUSHoursInput.removeAttribute('aria-invalid');
                            FlightApp.elements.purserNonUSHoursInput.removeAttribute('aria-invalid');
                        }
                    } else {
                        // Clear all error messages if valid
                        FlightApp.elements.galleyHoursValidation.style.display = 'none';
                        FlightApp.elements.purserUSHoursValidation.style.display = 'none';
                        FlightApp.elements.purserNonUSHoursValidation.style.display = 'none';
                        
                        // Reset aria-invalid attributes
                        FlightApp.elements.galleyHoursHoursInput.removeAttribute('aria-invalid');
                        FlightApp.elements.galleyHoursMinutesInput.removeAttribute('aria-invalid');
                        FlightApp.elements.purserUSHoursInput.removeAttribute('aria-invalid');
                        FlightApp.elements.purserNonUSHoursInput.removeAttribute('aria-invalid');
                    }
                    
                    // Validate holiday hours against TAFB time
                    const thH = parseInt(FlightApp.elements.tafbHoursInput.value, 10) || 0;
                    const thM = parseInt(FlightApp.elements.tafbMinutesInput.value, 10) || 0;
                    const tafbHours = thH + (thM / 60);
                    
                    const holidayHours = FlightApp.elements.holidayPayToggle.checked ? 
                        Math.max(0, parseFloat(FlightApp.elements.holidayHoursInput.value) || 0) : 0;
                    
                    if (FlightApp.elements.holidayPayToggle.checked && holidayHours > tafbHours) {
                        const message = `Holiday hours (${holidayHours.toFixed(2)}) cannot exceed TAFB time (${tafbHours.toFixed(2)})`;
                        FlightApp.elements.holidayHoursValidation.textContent = message;
                        FlightApp.elements.holidayHoursValidation.style.display = 'block';
                        FlightApp.elements.holidayHoursInput.setAttribute('aria-invalid', 'true');
                        return false;
                    } else {
                        FlightApp.elements.holidayHoursValidation.style.display = 'none';
                        FlightApp.elements.holidayHoursInput.removeAttribute('aria-invalid');
                    }
                    
                    return isValid;
                } catch (error) {
                    console.error('Error validating hours:', error);
                    return false;
                }
            },

            // Toggle label update function
            updateToggleLabel: function(toggle, labelElement) {
                labelElement.textContent = toggle.checked ? 'Yes' : 'No';
                
                // Update aria-checked attribute on the toggle slider
                const toggleSlider = toggle.nextElementSibling;
                if (toggleSlider && toggleSlider.hasAttribute('aria-checked')) {
                    toggleSlider.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
                }
            },

            // Setup toggle event listeners
            setupToggleListeners: function() {
                const setupToggle = function(toggleId) {
                    const toggle = document.getElementById(toggleId);
                    const toggleLabel = document.getElementById(`${toggleId}-label`);
                    const toggleSlider = toggle.nextElementSibling;
                    
                    // Update initial state
                    if (toggleSlider) {
                        toggleSlider.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
                    }
                    
                    // Click handler
                    toggle.addEventListener('change', function() {
                        FlightApp.updateToggleLabel(toggle, toggleLabel);
                        
                        // Call additional handlers if needed
                        if (toggleId === 'purple-flag' || toggleId === 'galley-pay' || toggleId === 'purser-pay' || toggleId === 'holiday-pay') {
                            FlightApp.toggleConditionalFields();
                        }
                    });
                    
                    // Keyboard handler for the toggle slider
                    if (toggleSlider) {
                        toggleSlider.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                toggle.checked = !toggle.checked;
                                
                                // Trigger the change event
                                const event = new Event('change');
                                toggle.dispatchEvent(event);
                            }
                        });
                    }
                };
                
                // Setup all toggles
                setupToggle('white-flag');
                setupToggle('purple-flag');
                setupToggle('galley-pay');
                setupToggle('purser-pay');
                setupToggle('intl-override');
                setupToggle('intl-pay-override');
                setupToggle('language-pay');
                setupToggle('holiday-pay');
            },

            // Calculate trip pay
            calculateTripPay: function(tripData) {
                try {
                    // Input validation with defaults
                    if (!tripData || typeof tripData !== 'object') {
                        console.error('Invalid trip data provided to calculation function');
                        return this.createDefaultCalculation();
                    }

                    const payYear = tripData.payYear || 'Year 1';
                    
                    // Get flag premium multiplier from the new white/purple flag system
                    const whiteFlagEnabled = tripData.whiteFlag === true || tripData.whiteFlag === 'Yes';
                    const purpleFlagEnabled = tripData.purpleFlag === true || tripData.purpleFlag === 'Yes';
                    const purpleFlagPremium = parseFloat(tripData.purpleFlagPremium) || 1.5;
                    
                    let flagPremiumMultiplier = 1;
                    if (whiteFlagEnabled) {
                        flagPremiumMultiplier *= 1.5;
                    }
                    if (purpleFlagEnabled) {
                        flagPremiumMultiplier *= purpleFlagPremium;
                    }
                    
                    // Parse and validate numeric inputs
                    const chH = parseInt(tripData.creditedHoursHours, 10) || 0;
                    const chM = parseInt(tripData.creditedHoursMinutes, 10) || 0;
                    const creditedHours = chH + (chM / 60);
                    
                    const thH = parseInt(tripData.tafbHours, 10) || 0;
                    const thM = parseInt(tripData.tafbMinutes, 10) || 0;
                    const dutyHours = thH + (thM / 60);
                    
                    const tripLength = parseInt(tripData.tripLength) || 1;
                    
                    // Feature flags
                    const hasGalleyPay = tripData.galleyPay === 'Yes';
                    const hasPurserPay = tripData.purserPay === 'Yes';
                    const hasIntlOverride = tripData.intlOverride === 'Yes';
                    const hasIntlPayOverride = tripData.intlPayOverride === 'Yes';
                    const hasLanguagePay = tripData.languagePay === 'Yes';
                    const hasHolidayPay = tripData.holidayPay === 'Yes';
                    
                    // Special hours
                    const ghH = hasGalleyPay ? (parseInt(tripData.galleyHoursHours, 10) || 0) : 0;
                    const ghM = hasGalleyPay ? (parseInt(tripData.galleyHoursMinutes, 10) || 0) : 0;
                    const galleyHours = ghH + (ghM / 60);
                    
                    const purserUSHours = hasPurserPay ? (parseFloat(tripData.purserUSHours) || 0) : 0;
                    const purserNonUSHours = hasPurserPay ? (parseFloat(tripData.purserNonUSHours) || 0) : 0;
                    
                    const holidayHours = hasHolidayPay ? (parseFloat(tripData.holidayHours) || 0) : 0;
                    
                    // Additional settings
                    const aircraftType = tripData.aircraftType || 'Narrow1';
                    const retirementPercentage = Math.max(0, Math.min(100, parseFloat(tripData.retirementPercentage) || 0));
                    const taxRate = Math.max(0, Math.min(100, parseFloat(tripData.taxRate) || 0));

                    // Verify pay rates exist for the selected year
                    if (!FlightApp.masterPayData[payYear]) {
                        console.error(`Pay year ${payYear} not found in master data`);
                        return this.createDefaultCalculation();
                    }

                    // Get rates
                    const baseRate = FlightApp.masterPayData[payYear].baseRate;
                    const effectiveRate = baseRate * flagPremiumMultiplier;
                    
                    // Per diem rate based on international status
                    const perDiemRate = hasIntlOverride ? FlightApp.constants.INTERNATIONAL_PER_DIEM_RATE : FlightApp.constants.DOMESTIC_PER_DIEM_RATE;

                    // Calculate pay components
                    const basePay = creditedHours * effectiveRate;
                    const galleyPay = hasGalleyPay ? galleyHours * 1 : 0;

                    // Calculate purser pay based on aircraft type
                    let purserPay = 0;
                    if (hasPurserPay) {
                        switch (aircraftType) {
                            case 'Narrow1':
                                purserPay = purserUSHours * 1 + purserNonUSHours * 2;
                                break;
                            case 'Narrow2':
                                purserPay = purserUSHours * 2 + purserNonUSHours * 3;
                                break;
                            case 'Wide':
                                purserPay = purserUSHours * 3 + purserNonUSHours * 4;
                                break;
                            default:
                                console.warn(`Unknown aircraft type: ${aircraftType}, using Narrow1 rates`);
                                purserPay = purserUSHours * 1 + purserNonUSHours * 2;
                        }
                    }

                    const intlOverridePay = hasIntlPayOverride ? creditedHours * 2 : 0;
                    const languagePay = hasLanguagePay ? creditedHours * 2.50 : 0;
                    const perDiem = dutyHours * perDiemRate;
                    
                    // Calculate holiday pay: (Hourly Rate × Credited Hours) ÷ TAFB × Holiday Hours
                    let holidayPay = 0;
                    if (hasHolidayPay && dutyHours > 0) {
                        holidayPay = (effectiveRate * creditedHours / dutyHours) * holidayHours;
                    }

                    // Calculate totals
                    const totalGrossPay = basePay + galleyPay + purserPay + intlOverridePay + languagePay + perDiem + holidayPay;
                    const retirementDeduction = totalGrossPay * (retirementPercentage / 100);
                    const netBeforeTax = totalGrossPay - retirementDeduction;
                    const netPayEstimate = netBeforeTax * (1 - taxRate / 100);
                    
                    const hourlyValue = creditedHours > 0 ? totalGrossPay / creditedHours : 0;
                    const perDayValue = tripLength > 0 ? totalGrossPay / tripLength : 0;

                    const result = {
                        baseRate,
                        flagRate: 0,
                        effectiveRate,
                        basePay,
                        galleyPay,
                        purserPay,
                        intlOverridePay,
                        languagePay,
                        perDiem,
                        holidayPay,
                        totalGrossPay,
                        netPayEstimate,
                        hourlyValue,
                        perDayValue
                    };

                    console.log(`Trip calculation for ${tripData.name}:`, {
                        payYear, creditedHours, dutyHours, tripLength,
                        perDiemRate, basePay, galleyPay, purserPay, intlOverridePay, languagePay, perDiem, holidayPay,
                        totalGrossPay, netPayEstimate, hourlyValue, perDayValue
                    });

                    return result;
                } catch (error) {
                    console.error('Error calculating trip pay:', error);
                    return this.createDefaultCalculation();
                }
            },

            // Default calculation result when errors occur
            createDefaultCalculation: function() {
                return {
                    baseRate: 0,
                    flagRate: 0,
                    effectiveRate: 0,
                    basePay: 0,
                    galleyPay: 0,
                    purserPay: 0,
                    intlOverridePay: 0,
                    languagePay: 0,
                    perDiem: 0,
                    holidayPay: 0,
                    totalGrossPay: 0,
                    netPayEstimate: 0,
                    hourlyValue: 0,
                    perDayValue: 0
                };
            },

            // Toggle side panel
            toggleSidePanel: function(show = true) {
                if (show) {
                    FlightApp.elements.sidePanel.classList.remove('collapsed');
                    FlightApp.elements.addTripBtn.style.display = 'none';
                    
                    // Focus the first input in the form
                    setTimeout(() => {
                        FlightApp.elements.tripNameInput.focus();
                        
                        // Setup focus trap for the side panel
                        FlightApp.setupFocusTrap();
                    }, 100);
                    
                    console.log('Side panel opened');
                } else {
                    FlightApp.elements.sidePanel.classList.add('collapsed');
                    FlightApp.elements.addTripBtn.style.display = 'flex';
                    
                    // Remove focus trap
                    FlightApp.removeFocusTrap();
                    
                    console.log('Side panel closed');
                }
            },
            
            // Setup focus trap for the side panel
            setupFocusTrap: function() {
                // Remove any existing event listener first
                document.removeEventListener('keydown', FlightApp.handleFocusTrap);
                document.addEventListener('keydown', FlightApp.handleFocusTrap);
                
                // Add a return to content skip link when the panel is open
                const skipNavContainer = document.querySelector('.skip-nav-container');
                const existingReturnLink = document.getElementById('return-to-content');
                
                if (skipNavContainer && !existingReturnLink) {
                    const returnLink = document.createElement('a');
                    returnLink.href = "#trip-comparison";
                    returnLink.className = "skip-link";
                    returnLink.id = "return-to-content";
                    returnLink.textContent = "Return to main content";
                    skipNavContainer.appendChild(returnLink);
                }
            },
            
            // Remove focus trap
            removeFocusTrap: function() {
                document.removeEventListener('keydown', FlightApp.handleFocusTrap);
                
                // Remove the return to content link when the panel is closed
                const returnLink = document.getElementById('return-to-content');
                if (returnLink) {
                    returnLink.remove();
                }
            },
            
            // Handle focus trap
            handleFocusTrap: function(e) {
                if (e.key !== 'Tab') return;
                
                // Only trap focus if side panel is open
                if (FlightApp.elements.sidePanel.classList.contains('collapsed')) return;
                
                // Get all focusable elements in the side panel
                const focusableElements = FlightApp.elements.sidePanel.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                
                // Handle focus cycling
                if (e.shiftKey) { // Shift+Tab
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else { // Tab
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            },

            // Reset form
            resetForm: function() {
                FlightApp.elements.tripForm.reset();
                FlightApp.elements.tripIdInput.value = '';
                
                // Clear all validation states
                FlightApp.elements.galleyHoursValidation.style.display = 'none';
                FlightApp.elements.purserUSHoursValidation.style.display = 'none';
                FlightApp.elements.purserNonUSHoursValidation.style.display = 'none';
                FlightApp.elements.holidayHoursValidation.style.display = 'none';
                
                // Reset aria-invalid attributes
                const formInputs = FlightApp.elements.tripForm.querySelectorAll('input, select');
                formInputs.forEach(input => {
                    input.style.borderColor = '';
                    input.removeAttribute('aria-invalid');
                });
                
                // Hide all validation messages
                const validationMessages = FlightApp.elements.tripForm.querySelectorAll('.validation-message');
                validationMessages.forEach(msg => {
                    msg.style.display = 'none';
                });
                
                FlightApp.state.editingTripId = null;
                
                // Reset toggle labels
                FlightApp.updateToggleLabel(FlightApp.elements.whiteFlagToggle, FlightApp.elements.whiteFlagLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.purpleFlagToggle, FlightApp.elements.purpleFlagLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.galleyPayToggle, FlightApp.elements.galleyPayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.purserPayToggle, FlightApp.elements.purserPayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.intlOverrideToggle, FlightApp.elements.intlOverrideLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.intlPayOverrideToggle, FlightApp.elements.intlPayOverrideLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.languagePayToggle, FlightApp.elements.languagePayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.holidayPayToggle, FlightApp.elements.holidayPayLabel);
                
                FlightApp.toggleConditionalFields();
                console.log('Form reset');
            },

            // Toggle conditional fields
            toggleConditionalFields: function() {
                // Purple Flag Dropdown
                const showPurpleFlagDropdown = FlightApp.elements.purpleFlagToggle.checked;
                FlightApp.elements.purpleFlagDropdownGroup.style.display = showPurpleFlagDropdown ? 'block' : 'none';
                FlightApp.elements.purpleFlagPremiumSelect.disabled = !showPurpleFlagDropdown;

                // Galley Hours
                const showGalleyHours = FlightApp.elements.galleyPayToggle.checked;
                FlightApp.elements.galleyHoursGroup.style.display = showGalleyHours ? 'block' : 'none';
                FlightApp.elements.galleyHoursHoursInput.disabled = !showGalleyHours;
                FlightApp.elements.galleyHoursMinutesInput.disabled = !showGalleyHours;

                // Purser Fields
                const showPurserFields = FlightApp.elements.purserPayToggle.checked;
                FlightApp.elements.purserFieldsGroup.style.display = showPurserFields ? 'block' : 'none';
                FlightApp.elements.aircraftTypeSelect.disabled = !showPurserFields;
                FlightApp.elements.purserUSHoursInput.disabled = !showPurserFields;
                FlightApp.elements.purserNonUSHoursInput.disabled = !showPurserFields;
                
                // Holiday Hours
                const showHolidayHours = FlightApp.elements.holidayPayToggle.checked;
                FlightApp.elements.holidayHoursGroup.style.display = showHolidayHours ? 'block' : 'none';
                FlightApp.elements.holidayHoursInput.disabled = !showHolidayHours;
                
                console.log('Conditional fields updated:', {
                    purpleFlagDropdownVisible: showPurpleFlagDropdown,
                    galleyHoursVisible: showGalleyHours,
                    purserFieldsVisible: showPurserFields,
                    holidayHoursVisible: showHolidayHours
                });
            },

            // Show toast notification
            showToast: function(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                // Replace innerHTML with safer DOM manipulation
                if (message.includes('Undo')) {
                    // Split the message at "Undo" to separate text and link
                    const parts = message.split(/(<a.*?Undo<\/a>)/);
                    
                    // Add the text part
                    const textNode = document.createTextNode(parts[0]);
                    toast.appendChild(textNode);
                    
                    // Create and add the undo link
                    const undoLink = document.createElement('a');
                    undoLink.href = "#";
                    undoLink.id = "undo-delete";
                    undoLink.textContent = "Undo";
                    toast.appendChild(undoLink);
                } else {
                    // Simple text message
                    toast.textContent = message;
                }
                
                FlightApp.elements.toastContainer.appendChild(toast);
                console.log(`Toast notification: ${message} (${type})`);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            FlightApp.elements.toastContainer.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            },

            // Render trip card
            renderTripCard: function(trip) {
                try {
                    if (!trip || !trip.id) {
                        console.error('Invalid trip data provided to renderTripCard');
                        return document.createElement('div'); // Return empty div to avoid errors
                    }

                    const calculation = FlightApp.calculateTripPay(trip);
                    
                    const tripCardEl = document.createElement('div');
                    tripCardEl.className = 'trip-card';
                    tripCardEl.dataset.id = trip.id;
                    
                    // Add best value badge (hidden by default)
                    const bestValueBadge = document.createElement('div');
                    bestValueBadge.className = 'best-value-badge';
                    bestValueBadge.textContent = 'Best Value';
                    tripCardEl.appendChild(bestValueBadge);

                    // Format trip details with fallbacks for missing data
                    const safeValues = {
                        name: trip.name || 'Unnamed Trip',
                        payYear: trip.payYear || 'Year 1',
                        whiteFlag: trip.whiteFlag === true || trip.whiteFlag === 'Yes',
                        purpleFlag: trip.purpleFlag === true || trip.purpleFlag === 'Yes',
                        purpleFlagPremium: trip.purpleFlagPremium || '1.5',
                        creditedHoursHours: trip.creditedHoursHours || '0',
                        creditedHoursMinutes: trip.creditedHoursMinutes || '0',
                        tafbHours: trip.tafbHours || '0',
                        tafbMinutes: trip.tafbMinutes || '0',
                        tripLength: trip.tripLength || '1',
                        galleyPay: trip.galleyPay || 'No',
                        galleyHoursHours: trip.galleyHoursHours || '0',
                        galleyHoursMinutes: trip.galleyHoursMinutes || '0',
                        languagePay: trip.languagePay || 'No',
                        color: trip.color || '#3a36e0'
                    };

                    // Create header
                    const header = document.createElement('div');
                    header.className = 'trip-card-header';
                    header.style.backgroundColor = safeValues.color;
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'trip-title';
                    titleDiv.textContent = safeValues.name;
                    header.appendChild(titleDiv);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'trip-card-actions';
                    
                    const editAction = document.createElement('button');
                    editAction.className = 'trip-card-action edit-trip';
                    editAction.dataset.id = trip.id;
                    editAction.textContent = '✏️';
                    editAction.setAttribute('aria-label', `Edit trip ${safeValues.name}`);
                    editAction.setAttribute('type', 'button');
                    actionsDiv.appendChild(editAction);
                    
                    const deleteAction = document.createElement('button');
                    deleteAction.className = 'trip-card-action delete-trip';
                    deleteAction.dataset.id = trip.id;
                    deleteAction.textContent = '🗑️';
                    deleteAction.setAttribute('aria-label', `Delete trip ${safeValues.name}`);
                    deleteAction.setAttribute('type', 'button');
                    actionsDiv.appendChild(deleteAction);
                    
                    header.appendChild(actionsDiv);
                    tripCardEl.appendChild(header);
                    
                    // Create body
                    const body = document.createElement('div');
                    body.className = 'trip-card-body';
                    
                    // Trip details section
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'trip-details';
                    
                    // Helper function to create detail rows
                    const createDetailRow = (label, value) => {
                        const detailRow = document.createElement('div');
                        detailRow.className = 'trip-detail';
                        
                        const labelSpan = document.createElement('span');
                        labelSpan.className = 'trip-detail-label';
                        labelSpan.textContent = label;
                        detailRow.appendChild(labelSpan);
                        
                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'trip-detail-value';
                        valueSpan.textContent = value;
                        detailRow.appendChild(valueSpan);
                        
                        return detailRow;
                    };
                    
                    // Add standard details
                    detailsDiv.appendChild(createDetailRow('Pay Year', safeValues.payYear));
                    
                    // Display flag information
                    let flagText = 'None';
                    if (safeValues.whiteFlag && safeValues.purpleFlag) {
                        flagText = `White + Purple (${parseFloat(safeValues.purpleFlagPremium) * 100}%)`;
                    } else if (safeValues.whiteFlag) {
                        flagText = 'White Flag (150%)';
                    } else if (safeValues.purpleFlag) {
                        flagText = `Purple Flag (${parseFloat(safeValues.purpleFlagPremium) * 100}%)`;
                    }
                    detailsDiv.appendChild(createDetailRow('Flags', flagText));
                    
                    detailsDiv.appendChild(createDetailRow('Credited Hours', 
                        `${safeValues.creditedHoursHours}h ${safeValues.creditedHoursMinutes}m`));
                    detailsDiv.appendChild(createDetailRow('TAFB time', 
                        `${safeValues.tafbHours}h ${safeValues.tafbMinutes}m`));
                    
                    // Conditional galley hours
                    if (safeValues.galleyPay === 'Yes') {
                        detailsDiv.appendChild(createDetailRow('Galley Hours', 
                            `${safeValues.galleyHoursHours}h ${safeValues.galleyHoursMinutes}m`));
                    }
                    
                    // Trip length with plural handling
                    const tripLengthText = `${safeValues.tripLength} day${parseInt(safeValues.tripLength, 10) > 1 ? 's' : ''}`;
                    detailsDiv.appendChild(createDetailRow('Trip Length', tripLengthText));
                    
                    body.appendChild(detailsDiv);
                    
                    // Trip summary section
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'trip-summary';
                    
                    // Helper function to create summary items
                    const createSummaryItem = (label, value, isHighlight = false) => {
                        const item = document.createElement('div');
                        item.className = 'trip-summary-item';
                        if (isHighlight) item.classList.add('highlight');
                        
                        const labelSpan = document.createElement('span');
                        labelSpan.className = 'trip-summary-label';
                        labelSpan.textContent = label;
                        item.appendChild(labelSpan);
                        
                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'trip-summary-value';
                        valueSpan.textContent = value;
                        item.appendChild(valueSpan);
                        
                        return item;
                    };
                    
                    // Add summary items
                    summaryDiv.appendChild(createSummaryItem('Base Pay', FlightApp.utils.formatCurrency(calculation.basePay)));
                    
                    if (calculation.galleyPay > 0) {
                        summaryDiv.appendChild(createSummaryItem('Galley Pay', FlightApp.utils.formatCurrency(calculation.galleyPay)));
                    }
                    
                    if (calculation.purserPay > 0) {
                        summaryDiv.appendChild(createSummaryItem('Purser Pay', FlightApp.utils.formatCurrency(calculation.purserPay)));
                    }
                    
                    if (calculation.intlOverridePay > 0) {
                        summaryDiv.appendChild(createSummaryItem('Intl Override', FlightApp.utils.formatCurrency(calculation.intlOverridePay)));
                    }
                    
                    if (calculation.languagePay > 0) {
                        summaryDiv.appendChild(createSummaryItem('Language Pay', FlightApp.utils.formatCurrency(calculation.languagePay)));
                    }
                    
                    summaryDiv.appendChild(createSummaryItem('Per Diem', FlightApp.utils.formatCurrency(calculation.perDiem)));
                    
                    if (calculation.holidayPay > 0) {
                        summaryDiv.appendChild(createSummaryItem('Holiday Pay', FlightApp.utils.formatCurrency(calculation.holidayPay)));
                    }
                    
                    summaryDiv.appendChild(createSummaryItem('Gross Pay', FlightApp.utils.formatCurrency(calculation.totalGrossPay), true));
                    
                    // Net pay estimate (conditional)
                    if (parseFloat(trip.retirementPercentage) > 0 || parseFloat(trip.taxRate) > 0) {
                        summaryDiv.appendChild(createSummaryItem('Net Pay Est.', 
                            FlightApp.utils.formatCurrency(calculation.netPayEstimate), true));
                    } else {
                        summaryDiv.appendChild(createSummaryItem('Net Pay Est.', '--', true));
                    }
                    
                    summaryDiv.appendChild(createSummaryItem('Hourly Value', 
                        `${FlightApp.utils.formatCurrency(calculation.hourlyValue)}/hr`));
                    summaryDiv.appendChild(createSummaryItem('Daily Value', 
                        `${FlightApp.utils.formatCurrency(calculation.perDayValue)}/day`));
                    
                    body.appendChild(summaryDiv);
                    tripCardEl.appendChild(body);
                    
                    return tripCardEl;
                } catch (error) {
                    console.error('Error rendering trip card:', error);
                    // Return a minimal error card
                    const errorCard = document.createElement('div');
                    errorCard.className = 'trip-card';
                    
                    const errorHeader = document.createElement('div');
                    errorHeader.className = 'trip-card-header';
                    errorHeader.style.backgroundColor = 'var(--danger)';
                    
                    const errorTitle = document.createElement('div');
                    errorTitle.className = 'trip-title';
                    errorTitle.textContent = trip?.name || 'Error';
                    errorHeader.appendChild(errorTitle);
                    
                    const errorActions = document.createElement('div');
                    errorActions.className = 'trip-card-actions';
                    
                    const deleteAction = document.createElement('button');
                    deleteAction.className = 'trip-card-action delete-trip';
                    deleteAction.dataset.id = trip?.id || '';
                    deleteAction.textContent = '🗑️';
                    deleteAction.setAttribute('aria-label', `Delete error trip ${trip?.name || 'Error'}`);
                    deleteAction.setAttribute('type', 'button');
                    errorActions.appendChild(deleteAction);
                    
                    errorHeader.appendChild(errorActions);
                    errorCard.appendChild(errorHeader);
                    
                    const errorBody = document.createElement('div');
                    errorBody.className = 'trip-card-body';
                    
                    const errorMessage = document.createElement('p');
                    errorMessage.textContent = 'There was an error rendering this trip. You may need to delete and recreate it.';
                    errorBody.appendChild(errorMessage);
                    
                    errorCard.appendChild(errorBody);
                    return errorCard;
                }
            },

            // Render all trips
            renderTrips: function() {
                try {
                    // Clear trip comparison area safely
                    while (FlightApp.elements.tripComparison.firstChild) {
                        FlightApp.elements.tripComparison.removeChild(FlightApp.elements.tripComparison.firstChild);
                    }
                    
                    // Handle no trips state
                    if (!FlightApp.state.trips || FlightApp.state.trips.length === 0) {
                        FlightApp.elements.tripComparison.appendChild(FlightApp.elements.noTripsMessage);
                        FlightApp.elements.noTripsMessage.style.display = 'flex';
                        FlightApp.saveTripsToLocalStorage();
                        return;
                    }
                    
                    FlightApp.elements.noTripsMessage.style.display = 'none';

                    // Find the best value trip
                    let bestValueTripId = null;
                    let bestMetric = -Infinity;
                    
                    FlightApp.state.trips.forEach(trip => {
                        try {
                            const calc = FlightApp.calculateTripPay(trip);
                            if (calc.perDayValue > bestMetric) {
                                bestMetric = calc.perDayValue;
                                bestValueTripId = trip.id;
                            }
                        } catch (error) {
                            console.error(`Error calculating best value for trip ${trip.name}:`, error);
                        }
                    });

                    console.log(`Best value trip identified: ${bestValueTripId} with value ${FlightApp.utils.formatCurrency(bestMetric)}/day`);

                    // Render each card
                    FlightApp.state.trips.forEach(trip => {
                        try {
                            const card = FlightApp.renderTripCard(trip);
                            
                            // Apply best trip styling if applicable
                            if (trip.id === bestValueTripId && FlightApp.state.trips.length > 1) {
                                card.classList.add('best-trip');
                                card.querySelector('.best-value-badge').style.display = 'block';
                            }
                            
                            FlightApp.elements.tripComparison.appendChild(card);

                            // Add event listeners for edit/delete
                            const editButton = card.querySelector(`.edit-trip[data-id="${trip.id}"]`);
                            const deleteButton = card.querySelector(`.delete-trip[data-id="${trip.id}"]`);
                            
                            if (editButton) {
                                editButton.addEventListener('click', () => FlightApp.editTrip(trip.id));
                            }
                            
                            if (deleteButton) {
                                deleteButton.addEventListener('click', () => FlightApp.deleteTrip(trip.id));
                            }
                        } catch (error) {
                            console.error(`Error rendering trip ${trip.name}:`, error);
                        }
                    });

                    FlightApp.saveTripsToLocalStorage();
                } catch (error) {
                    console.error('Error rendering trips:', error);
                    FlightApp.showToast('Error displaying trips. Please refresh the page.', 'error');
                }
            },

            // Save trips to local storage
            saveTripsToLocalStorage: function() {
                try {
                    if (!FlightApp.state.trips) {
                        console.warn('No trips to save to localStorage');
                        return;
                    }
                    
                    // Create data structure with version information
                    const storageData = {
                        version: FlightApp.constants.VERSION,
                        lastUpdated: new Date().toISOString(),
                        tripCount: FlightApp.state.trips.length,
                        trips: FlightApp.state.trips
                    };
                    
                    localStorage.setItem(FlightApp.constants.STORAGE_KEY, JSON.stringify(storageData));
                    console.log(`Saved ${FlightApp.state.trips.length} trips to local storage`);
                } catch (error) {
                    console.error('Error saving trips to localStorage:', error);
                    FlightApp.showToast('Error saving your trips. Some data may be lost if you refresh.', 'error');
                }
            },

            // Load trips from local storage
            loadTripsFromLocalStorage: function() {
                try {
                    const saved = localStorage.getItem(FlightApp.constants.STORAGE_KEY);
                    if (!saved) {
                        console.log('No saved trips found in localStorage');
                        FlightApp.state.trips = [];
                        return;
                    }
                    
                    const parsedData = JSON.parse(saved);
                    
                    // Handle both new format (with version) and old format (just array)
                    if (Array.isArray(parsedData)) {
                        // Old format - direct array
                        FlightApp.state.trips = parsedData;
                        console.log(`Loaded ${FlightApp.state.trips.length} trips from localStorage (legacy format)`);
                    } else if (parsedData && parsedData.trips && Array.isArray(parsedData.trips)) {
                        // New format - object with trips array
                        FlightApp.state.trips = parsedData.trips;
                        console.log(`Loaded ${FlightApp.state.trips.length} trips from localStorage (v${parsedData.version || 'unknown'})`);
                    } else {
                        console.error('Invalid data format in localStorage');
                        FlightApp.state.trips = [];
                        FlightApp.showToast('Could not load saved trips due to data format issues', 'error');
                        return;
                    }
                    
                    // Validate loaded trips
                    FlightApp.state.trips = FlightApp.state.trips.filter(trip => {
                        return trip && typeof trip === 'object' && trip.id && trip.name;
                    });
                    
                    FlightApp.renderTrips();
                } catch (error) {
                    console.error('Error loading trips from localStorage:', error);
                    FlightApp.showToast('Error loading your saved trips', 'error');
                    FlightApp.state.trips = [];
                }
            },

            // Add new trip
            addTrip: function(tripData) {
                try {
                    // Save state for potential undo
                    FlightApp.history.saveState('add', 'new');
                    
                    const newTrip = {
                        id: FlightApp.utils.generateId(),
                        color: FlightApp.utils.getRandomColor(),
                        ...tripData
                    };
                    
                    FlightApp.state.trips.push(newTrip);
                    FlightApp.renderTrips();
                    console.log(`Added new trip: ${newTrip.name}`);
                    FlightApp.showToast(`Trip "${newTrip.name}" added successfully`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error adding trip:', error);
                    FlightApp.showToast('Error adding trip', 'error');
                    return false;
                }
            },

            // Update existing trip
            updateTrip: function(tripId, tripData) {
                try {
                    const index = FlightApp.state.trips.findIndex(t => t.id === tripId);
                    if (index === -1) {
                        FlightApp.showToast('Trip not found', 'error');
                        return false;
                    }
                    
                    // Save state for potential undo
                    FlightApp.history.saveState('update', tripId);
                    
                    const oldColor = FlightApp.state.trips[index].color;
                    FlightApp.state.trips[index] = {
                        ...tripData,
                        id: tripId,
                        color: oldColor
                    };
                    
                    FlightApp.renderTrips();
                    console.log(`Updated trip: ${tripData.name}`);
                    FlightApp.showToast(`Trip "${tripData.name}" updated successfully`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error updating trip:', error);
                    FlightApp.showToast('Error updating trip', 'error');
                    return false;
                }
            },

            // Delete trip
            deleteTrip: function(tripId) {
                try {
                    const index = FlightApp.state.trips.findIndex(t => t.id === tripId);
                    if (index === -1) {
                        FlightApp.showToast('Trip not found', 'error');
                        return false;
                    }
                    
                    const tripName = FlightApp.state.trips[index].name;
                    
                    // Confirm before deleting
                    if (!confirm(`Are you sure you want to delete the trip "${tripName}"?`)) {
                        return false;
                    }
                    
                    // Save state for potential undo
                    FlightApp.history.saveState('delete', tripId);
                    
                    FlightApp.state.trips.splice(index, 1);
                    FlightApp.renderTrips();
                    console.log(`Deleted trip: ${tripName}`);
                    FlightApp.showToast(`Trip "${tripName}" deleted. <a href="#" id="undo-delete">Undo</a>`, 'info');
                    
                    // Setup undo link
                    setTimeout(() => {
                        const undoLink = document.getElementById('undo-delete');
                        if (undoLink) {
                            undoLink.addEventListener('click', function(e) {
                                e.preventDefault();
                                FlightApp.history.undoLastOperation();
                            });
                        }
                    }, 10);
                    
                    return true;
                } catch (error) {
                    console.error('Error deleting trip:', error);
                    FlightApp.showToast('Error deleting trip', 'error');
                    return false;
                }
            },

            // Edit trip
            editTrip: function(tripId) {
                const trip = FlightApp.state.trips.find(t => t.id === tripId);
                if (!trip) return;
                
                // Set form to edit mode
                FlightApp.elements.panelTitle.textContent = 'Edit Trip';
                FlightApp.elements.tripIdInput.value = trip.id;
                FlightApp.state.editingTripId = trip.id;
                
                // Fill form with trip data
                FlightApp.elements.tripNameInput.value = trip.name;
                FlightApp.elements.payYearSelect.value = trip.payYear;
                
                // Handle new white/purple flag structure or legacy flagRate
                if (trip.whiteFlag !== undefined) {
                    FlightApp.elements.whiteFlagToggle.checked = trip.whiteFlag === true || trip.whiteFlag === 'Yes';
                    FlightApp.elements.purpleFlagToggle.checked = trip.purpleFlag === true || trip.purpleFlag === 'Yes';
                    FlightApp.elements.purpleFlagPremiumSelect.value = trip.purpleFlagPremium || '1.5';
                } else if (trip.flagRate !== undefined) {
                    // Legacy support for old flagRate
                    FlightApp.elements.whiteFlagToggle.checked = trip.flagRate === 'Yes';
                    FlightApp.elements.purpleFlagToggle.checked = false;
                    FlightApp.elements.purpleFlagPremiumSelect.value = '1.5';
                } else {
                    // Default values
                    FlightApp.elements.whiteFlagToggle.checked = false;
                    FlightApp.elements.purpleFlagToggle.checked = false;
                    FlightApp.elements.purpleFlagPremiumSelect.value = '1.5';
                }
                FlightApp.elements.creditedHoursHoursInput.value = trip.creditedHoursHours;
                FlightApp.elements.creditedHoursMinutesInput.value = trip.creditedHoursMinutes;
                FlightApp.elements.tafbHoursInput.value = trip.tafbHours;
                FlightApp.elements.tafbMinutesInput.value = trip.tafbMinutes;
                FlightApp.elements.tripLengthSelect.value = trip.tripLength;
                FlightApp.elements.galleyPayToggle.checked = trip.galleyPay === 'Yes';
                
                // Handle both old (single field) and new (hours/minutes) formats for galley hours
                if (trip.galleyHoursHours !== undefined) {
                    FlightApp.elements.galleyHoursHoursInput.value = trip.galleyHoursHours || 0;
                    FlightApp.elements.galleyHoursMinutesInput.value = trip.galleyHoursMinutes || 0;
                } else if (trip.galleyHours !== undefined) {
                    // Convert old decimal format to hours/minutes
                    const galleyHoursDecimal = parseFloat(trip.galleyHours) || 0;
                    const galleyHoursWhole = Math.floor(galleyHoursDecimal);
                    const galleyMinutes = Math.round((galleyHoursDecimal - galleyHoursWhole) * 60);
                    
                    FlightApp.elements.galleyHoursHoursInput.value = galleyHoursWhole;
                    FlightApp.elements.galleyHoursMinutesInput.value = galleyMinutes;
                } else {
                    // Default values
                    FlightApp.elements.galleyHoursHoursInput.value = 0;
                    FlightApp.elements.galleyHoursMinutesInput.value = 0;
                }
                
                FlightApp.elements.purserPayToggle.checked = trip.purserPay === 'Yes';
                FlightApp.elements.aircraftTypeSelect.value = trip.aircraftType;
                FlightApp.elements.purserUSHoursInput.value = trip.purserUSHours || 0;
                FlightApp.elements.purserNonUSHoursInput.value = trip.purserNonUSHours || 0;
                FlightApp.elements.intlOverrideToggle.checked = trip.intlOverride === 'Yes';
                FlightApp.elements.intlPayOverrideToggle.checked = trip.intlPayOverride === 'Yes';
                FlightApp.elements.languagePayToggle.checked = trip.languagePay === 'Yes';
                FlightApp.elements.holidayPayToggle.checked = trip.holidayPay === 'Yes';
                FlightApp.elements.holidayHoursInput.value = trip.holidayHours || 0;
                FlightApp.elements.retirementPercentageInput.value = trip.retirementPercentage;
                FlightApp.elements.taxRateInput.value = trip.taxRate;
                
                // Update toggle labels
                FlightApp.updateToggleLabel(FlightApp.elements.whiteFlagToggle, FlightApp.elements.whiteFlagLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.purpleFlagToggle, FlightApp.elements.purpleFlagLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.galleyPayToggle, FlightApp.elements.galleyPayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.purserPayToggle, FlightApp.elements.purserPayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.intlOverrideToggle, FlightApp.elements.intlOverrideLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.intlPayOverrideToggle, FlightApp.elements.intlPayOverrideLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.languagePayToggle, FlightApp.elements.languagePayLabel);
                FlightApp.updateToggleLabel(FlightApp.elements.holidayPayToggle, FlightApp.elements.holidayPayLabel);
                
                // Show conditional fields
                FlightApp.toggleConditionalFields();
                
                // Show panel
                FlightApp.toggleSidePanel(true);
                
                console.log(`Editing trip: ${trip.name}`);
            },

            // Export trips
            exportTrips: function() {
                if (FlightApp.state.trips.length === 0) {
                    FlightApp.showToast('No trips to export', 'warning');
                    return;
                }
                
                const exportData = {
                    trips: FlightApp.state.trips,
                    exportDate: new Date().toISOString(),
                    version: FlightApp.constants.VERSION
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'flight_trips_export.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                console.log('Trips exported');
                FlightApp.showToast('Trips exported successfully', 'success');
            },

            // Clear all trips
            clearAllTrips: function() {
                if (FlightApp.state.trips.length === 0) return;
                
                if (confirm('Are you sure you want to clear all trips? This cannot be undone.')) {
                    FlightApp.state.trips = [];
                    FlightApp.renderTrips();
                    console.log('All trips cleared');
                    FlightApp.showToast('All trips cleared', 'info');
                }
            },

            // Validate form
            validateForm: function() {
                try {
                    const requiredFields = [
                        { element: FlightApp.elements.tripNameInput, message: "Trip name is required" },
                        { element: FlightApp.elements.payYearSelect, message: "Pay year is required" },
                        { element: FlightApp.elements.creditedHoursHoursInput, message: "Credited hours is required" },
                        { element: FlightApp.elements.creditedHoursMinutesInput, message: "Credited minutes is required" },
                        { element: FlightApp.elements.tafbHoursInput, message: "TAFB hours is required" },
                        { element: FlightApp.elements.tafbMinutesInput, message: "TAFB minutes is required" },
                        { element: FlightApp.elements.tripLengthSelect, message: "Trip length is required" }
                    ];
                    
                    let isValid = true;
                    let firstInvalidField = null;
                    
                    // Check each required field
                    requiredFields.forEach(field => {
                        // Get or create error message element
                        let errorMsgId = `${field.element.id}-error`;
                        let errorMsgElement = document.getElementById(errorMsgId);
                        
                        if (!errorMsgElement) {
                            errorMsgElement = document.createElement('div');
                            errorMsgElement.id = errorMsgId;
                            errorMsgElement.className = 'validation-message';
                            errorMsgElement.setAttribute('role', 'alert');
                            errorMsgElement.setAttribute('aria-live', 'assertive');
                            field.element.parentNode.appendChild(errorMsgElement);
                            
                            // Set aria-describedby on the input
                            field.element.setAttribute('aria-describedby', errorMsgId);
                        }
                        
                        if (!field.element.value.trim()) {
                            field.element.style.borderColor = 'var(--danger)';
                            field.element.setAttribute('aria-invalid', 'true');
                            
                            // Update error message
                            errorMsgElement.textContent = field.message;
                            errorMsgElement.style.display = 'block';
                            
                            if (!firstInvalidField) firstInvalidField = field.element;
                            isValid = false;
                        } else {
                            field.element.style.borderColor = '';
                            field.element.removeAttribute('aria-invalid');
                            errorMsgElement.style.display = 'none';
                        }
                    });
                    
                    // Check hour validations
                    if (!FlightApp.validateHours()) {
                        isValid = false;
                        
                        // If there's no first invalid field yet, set it to the first visible validation message
                        if (!firstInvalidField) {
                            if (FlightApp.elements.galleyHoursValidation.style.display === 'block') {
                                firstInvalidField = FlightApp.elements.galleyHoursHoursInput;
                            } else if (FlightApp.elements.purserUSHoursValidation.style.display === 'block') {
                                firstInvalidField = FlightApp.elements.purserUSHoursInput;
                            }
                        }
                    }
                    
                    // Focus the first invalid field
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                    }
                    
                    return isValid;
                } catch (error) {
                    console.error('Error validating form:', error);
                    return false;
                }
            },

            // Form submit handler
            tripFormSubmitHandler: function(e) {
                e.preventDefault();

                // 1) If invalid, bail out immediately
                if (!FlightApp.validateForm()) {
                    FlightApp.showToast('Please fix the errors in the form', 'error');
                    return;
                }

                // 2) Build your tripData object
                const tripData = {
                    name: FlightApp.elements.tripNameInput.value,
                    payYear: FlightApp.elements.payYearSelect.value,
                    whiteFlag: FlightApp.elements.whiteFlagToggle.checked,
                    purpleFlag: FlightApp.elements.purpleFlagToggle.checked,
                    purpleFlagPremium: FlightApp.elements.purpleFlagPremiumSelect.value,
                    creditedHoursHours: FlightApp.elements.creditedHoursHoursInput.value,
                    creditedHoursMinutes: FlightApp.elements.creditedHoursMinutesInput.value,
                    tafbHours: FlightApp.elements.tafbHoursInput.value,
                    tafbMinutes: FlightApp.elements.tafbMinutesInput.value,
                    tripLength: FlightApp.elements.tripLengthSelect.value,
                    galleyPay: FlightApp.elements.galleyPayToggle.checked ? 'Yes' : 'No',
                    galleyHoursHours: FlightApp.elements.galleyHoursHoursInput.value,
                    galleyHoursMinutes: FlightApp.elements.galleyHoursMinutesInput.value,
                    purserPay: FlightApp.elements.purserPayToggle.checked ? 'Yes' : 'No',
                    aircraftType: FlightApp.elements.aircraftTypeSelect.value,
                    purserUSHours: FlightApp.elements.purserUSHoursInput.value,
                    purserNonUSHours: FlightApp.elements.purserNonUSHoursInput.value,
                    intlOverride: FlightApp.elements.intlOverrideToggle.checked ? 'Yes' : 'No',
                    intlPayOverride: FlightApp.elements.intlPayOverrideToggle.checked ? 'Yes' : 'No',
                    languagePay: FlightApp.elements.languagePayToggle.checked ? 'Yes' : 'No',
                    holidayPay: FlightApp.elements.holidayPayToggle.checked ? 'Yes' : 'No',
                    holidayHours: FlightApp.elements.holidayHoursInput.value,
                    retirementPercentage: FlightApp.elements.retirementPercentageInput.value,
                    taxRate: FlightApp.elements.taxRateInput.value
                };

                // 3) Add or update
                if (FlightApp.state.editingTripId) {
                    FlightApp.updateTrip(FlightApp.state.editingTripId, tripData);
                } else {
                    FlightApp.addTrip(tripData);
                }

                // 4) Clear the form & close the panel
                FlightApp.resetForm();
                FlightApp.toggleSidePanel(false);
            },
            
            // Add trip button handler
            addTripBtnHandler: function() {
                FlightApp.resetForm();
                FlightApp.elements.panelTitle.textContent = 'Add New Trip';
                FlightApp.toggleSidePanel(true);
            },

            // First trip button handler
            firstTripBtnHandler: function() {
                FlightApp.resetForm();
                FlightApp.elements.panelTitle.textContent = 'Add New Trip';
                FlightApp.toggleSidePanel(true);
            },

            // Panel close button handler
            panelCloseBtnHandler: function() {
                FlightApp.toggleSidePanel(false);
            },

            // Cancel button handler
            cancelBtnHandler: function() {
                FlightApp.toggleSidePanel(false);
            },

            // Clear all button handler
            clearAllBtnHandler: function() {
                FlightApp.clearAllTrips();
            },

            // Export button handler
            exportBtnHandler: function() {
                FlightApp.exportTrips();
            },

            // Validation handlers
            numericInputValidations: function() {
                const numericInputs = [
                    FlightApp.elements.creditedHoursHoursInput, 
                    FlightApp.elements.creditedHoursMinutesInput,
                    FlightApp.elements.tafbHoursInput,
                    FlightApp.elements.tafbMinutesInput,
                    FlightApp.elements.galleyHoursHoursInput,
                    FlightApp.elements.galleyHoursMinutesInput,
                    FlightApp.elements.purserUSHoursInput,
                    FlightApp.elements.purserNonUSHoursInput,
                    FlightApp.elements.holidayHoursInput,
                    FlightApp.elements.retirementPercentageInput,
                    FlightApp.elements.taxRateInput
                ];
                
                // Ensure minutes are within 0-59 range
                const minuteInputs = [
                    FlightApp.elements.creditedHoursMinutesInput, 
                    FlightApp.elements.tafbMinutesInput,
                    FlightApp.elements.galleyHoursMinutesInput
                ];
                
                minuteInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        const val = parseInt(this.value, 10);
                        if (isNaN(val)) {
                            this.value = '0';
                        } else if (val < 0) {
                            this.value = '0';
                        } else if (val > 59) {
                            this.value = '59';
                        }
                    });
                });
                
                // Ensure all numeric inputs are non-negative
                numericInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        // Allow empty or valid positive numbers only
                        if (this.value && !/^\d*\.?\d*$/.test(this.value)) {
                            this.value = this.value.replace(/[^\d.]/g, '');
                        }
                    });
                    
                    input.addEventListener('change', function() {
                        if (this.value === '') {
                            this.value = '0';
                        }
                        const val = parseFloat(this.value);
                        if (isNaN(val) || val < 0) {
                            this.value = '0';
                        }
                    });
                });
                
                // Specific validation for retirement and tax percentage (0-100)
                const percentageInputs = [FlightApp.elements.retirementPercentageInput, FlightApp.elements.taxRateInput];
                percentageInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        const val = parseFloat(this.value);
                        if (isNaN(val)) {
                            this.value = '0';
                        } else if (val < 0) {
                            this.value = '0';
                        } else if (val > 100) {
                            this.value = '100';
                        }
                    });
                });
            },

            // Setup keyboard shortcuts
            keyboardShortcuts: function() {
                document.addEventListener('keydown', function(e) {
                    // Only handle if not in an input field
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    // Alt+1: Jump to main content
                    if (e.altKey && e.key === '1') {
                        e.preventDefault();
                        const mainContent = document.getElementById('trip-comparison');
                        if (mainContent) {
                            mainContent.focus();
                            mainContent.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                    
                    // Alt+2: Jump to add trip button
                    if (e.altKey && e.key === '2') {
                        e.preventDefault();
                        const addTripBtn = document.getElementById('add-trip-btn');
                        if (addTripBtn) {
                            addTripBtn.focus();
                        }
                    }
                    
                    // Ctrl+N or Command+N: New Trip
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        if (FlightApp.elements.sidePanel.classList.contains('collapsed')) {
                            FlightApp.resetForm();
                            FlightApp.elements.panelTitle.textContent = 'Add New Trip';
                            FlightApp.toggleSidePanel(true);
                        }
                    }
                    
                    // Escape: Close panel
                    if (e.key === 'Escape') {
                        if (!FlightApp.elements.sidePanel.classList.contains('collapsed')) {
                            FlightApp.toggleSidePanel(false);
                        }
                    }
                    
                    // Ctrl+Z or Command+Z: Undo last operation
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        FlightApp.history.undoLastOperation();
                    }
                    
                    // Ctrl+S or Command+S: Save current trip
                    if ((e.ctrlKey || e.metaKey) && e.key === 's' && !FlightApp.elements.sidePanel.classList.contains('collapsed')) {
                        e.preventDefault();
                        FlightApp.elements.saveTripBtn.click();
                    }
                });
            },

            // Initialize
            init: function() {
                FlightApp.setupDOMElements();
                FlightApp.setupEventListeners();
                FlightApp.setupToggleListeners();
                FlightApp.loadTripsFromLocalStorage();
                FlightApp.toggleConditionalFields();
                FlightApp.numericInputValidations();
                FlightApp.keyboardShortcuts();
                FlightApp.adjustAddTripPanel(); // Adjust panel on page load
            },

            // Cache DOM elements
            setupDOMElements: function() {
                // Main elements
                FlightApp.elements.tripComparison = document.getElementById('trip-comparison');
                FlightApp.elements.noTripsMessage = document.getElementById('no-trips-message');
                FlightApp.elements.sidePanel = document.getElementById('side-panel');
                FlightApp.elements.addTripBtn = document.getElementById('add-trip-btn');
                FlightApp.elements.toastContainer = document.getElementById('toast-container');
                FlightApp.elements.panelTitle = document.getElementById('panel-title');
                FlightApp.elements.panelClose = document.getElementById('panel-close');
                
                // Form elements
                FlightApp.elements.tripForm = document.getElementById('trip-form');
                FlightApp.elements.tripIdInput = document.getElementById('trip-id');
                FlightApp.elements.tripNameInput = document.getElementById('trip-name');
                FlightApp.elements.payYearSelect = document.getElementById('pay-year');
                FlightApp.elements.whiteFlagToggle = document.getElementById('white-flag');
                FlightApp.elements.whiteFlagLabel = document.getElementById('white-flag-label');
                FlightApp.elements.purpleFlagToggle = document.getElementById('purple-flag');
                FlightApp.elements.purpleFlagLabel = document.getElementById('purple-flag-label');
                FlightApp.elements.purpleFlagDropdownGroup = document.getElementById('purple-flag-dropdown-group');
                FlightApp.elements.purpleFlagPremiumSelect = document.getElementById('purple-flag-premium');
                FlightApp.elements.creditedHoursHoursInput = document.getElementById('credited-hours-hours');
                FlightApp.elements.creditedHoursMinutesInput = document.getElementById('credited-hours-minutes');
                FlightApp.elements.tafbHoursInput = document.getElementById('tafb-hours');
                FlightApp.elements.tafbMinutesInput = document.getElementById('tafb-minutes');
                FlightApp.elements.tripLengthSelect = document.getElementById('trip-length');
                FlightApp.elements.galleyPayToggle = document.getElementById('galley-pay');
                FlightApp.elements.galleyPayLabel = document.getElementById('galley-pay-label');
                FlightApp.elements.galleyHoursGroup = document.getElementById('galley-hours-group');
                FlightApp.elements.galleyHoursHoursInput = document.getElementById('galley-hours-hours');
                FlightApp.elements.galleyHoursMinutesInput = document.getElementById('galley-hours-minutes');
                FlightApp.elements.galleyHoursValidation = document.getElementById('galley-hours-validation');
                FlightApp.elements.purserPayToggle = document.getElementById('purser-pay');
                FlightApp.elements.purserPayLabel = document.getElementById('purser-pay-label');
                FlightApp.elements.purserFieldsGroup = document.getElementById('purser-fields-group');
                FlightApp.elements.aircraftTypeSelect = document.getElementById('aircraft-type');
                FlightApp.elements.purserUSHoursInput = document.getElementById('purser-us-hours');
                FlightApp.elements.purserUSHoursValidation = document.getElementById('purser-us-hours-validation');
                FlightApp.elements.purserNonUSHoursInput = document.getElementById('purser-non-us-hours');
                FlightApp.elements.purserNonUSHoursValidation = document.getElementById('purser-non-us-hours-validation');
                FlightApp.elements.intlOverrideToggle = document.getElementById('intl-override');
                FlightApp.elements.intlOverrideLabel = document.getElementById('intl-override-label');
                FlightApp.elements.intlPayOverrideToggle = document.getElementById('intl-pay-override');
                FlightApp.elements.intlPayOverrideLabel = document.getElementById('intl-pay-override-label');
                FlightApp.elements.retirementPercentageInput = document.getElementById('retirement-percentage');
                FlightApp.elements.taxRateInput = document.getElementById('tax-rate');
                FlightApp.elements.holidayPayToggle = document.getElementById('holiday-pay');
                FlightApp.elements.holidayPayLabel = document.getElementById('holiday-pay-label');
                FlightApp.elements.holidayHoursGroup = document.getElementById('holiday-hours-group');
                FlightApp.elements.holidayHoursInput = document.getElementById('holiday-hours');
                FlightApp.elements.holidayHoursValidation = document.getElementById('holiday-hours-validation');
                FlightApp.elements.languagePayToggle = document.getElementById('language-pay');
                FlightApp.elements.languagePayLabel = document.getElementById('language-pay-label');
                
                // Buttons
                FlightApp.elements.saveTripBtn = document.getElementById('save-trip-btn');
                FlightApp.elements.cancelBtn = document.getElementById('cancel-btn');
                FlightApp.elements.firstTripBtn = document.getElementById('first-trip-btn');
                FlightApp.elements.exportBtn = document.getElementById('export-btn');
                FlightApp.elements.clearAllBtn = document.getElementById('clear-all-btn');
                
                console.log('DOM elements cached');
            },
            
            // Setup all event listeners
            setupEventListeners: function() {
                // Add trip button
                FlightApp.elements.addTripBtn.addEventListener('click', FlightApp.addTripBtnHandler);
                
                // First trip button (when no trips yet)
                FlightApp.elements.firstTripBtn.addEventListener('click', FlightApp.firstTripBtnHandler);
                
                // Panel close button
                FlightApp.elements.panelClose.addEventListener('click', FlightApp.panelCloseBtnHandler);
                
                // Cancel button
                FlightApp.elements.cancelBtn.addEventListener('click', FlightApp.cancelBtnHandler);
                
                // Trip form submission
                FlightApp.elements.tripForm.addEventListener('submit', FlightApp.tripFormSubmitHandler);
                
                // Export button
                if (FlightApp.elements.exportBtn) {
                    FlightApp.elements.exportBtn.addEventListener('click', FlightApp.exportBtnHandler);
                }
                
                // Clear all button
                if (FlightApp.elements.clearAllBtn) {
                    FlightApp.elements.clearAllBtn.addEventListener('click', FlightApp.clearAllBtnHandler);
                }
                
                // Resize event listener for panel adjustment
                window.addEventListener('resize', FlightApp.adjustAddTripPanel);
                
                console.log('Event listeners initialized');
            },

            // Dynamically adjust Add New Trip panel height & position for mobile
            adjustAddTripPanel: function() {
                try {
                    // Only apply adjustments on mobile/small screens or touch devices
                    const isMobile = window.innerWidth <= 1024 || 
                                   (window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);
                    
                    if (!isMobile) {
                        return; // Don't adjust on desktop
                    }
                    
                    // Select the header and side panel
                    const header = document.querySelector('.header');
                    const sidePanel = document.querySelector('.side-panel');
                    
                    if (!header || !sidePanel) {
                        console.warn('Header or side panel not found for adjustment');
                        return;
                    }
                    
                    // Measure header height and viewport height
                    const headerHeight = header.offsetHeight;
                    const viewportHeight = window.innerHeight;
                    
                    // Set panel position and height with !important to override CSS
                    sidePanel.style.setProperty('top', headerHeight + 'px', 'important');
                    sidePanel.style.setProperty('height', (viewportHeight - headerHeight) + 'px', 'important');
                    sidePanel.style.setProperty('overflow-y', 'auto', 'important');
                    
                    // Ensure position is fixed for mobile and proper z-index
                    sidePanel.style.setProperty('position', 'fixed', 'important');
                    sidePanel.style.setProperty('z-index', '999', 'important');
                    
                    // Ensure header has proper z-index
                    header.style.setProperty('z-index', '1000', 'important');
                    
                    console.log(`Adjusted side panel: top=${headerHeight}px, height=${viewportHeight - headerHeight}px, z-index=999`);
                } catch (error) {
                    console.error('Error adjusting Add Trip panel:', error);
                }
            }
        };

        // Initialize
        FlightApp.init();

        // Validation for "Hours on Holiday" field
        const holidayHoursInput = document.getElementById('holiday-hours');
        const holidayHoursValidation = document.getElementById('holiday-hours-validation');

        function validateHolidayHoursInput() {
          let value = parseFloat(holidayHoursInput.value);
          if (isNaN(value)) value = 0;
          if (value > 24) {
            holidayHoursInput.value = 24;
            holidayHoursValidation.textContent = "Maximum is 24 hours";
            holidayHoursValidation.style.display = "block";
            holidayHoursInput.setAttribute('aria-invalid', 'true');
          } else {
            holidayHoursValidation.style.display = "none";
            holidayHoursInput.removeAttribute('aria-invalid');
          }
        }

        // Validate on input and blur
        holidayHoursInput.addEventListener('input', validateHolidayHoursInput);
        holidayHoursInput.addEventListener('blur', validateHolidayHoursInput);

        // Also validate on form submission (inside your validateForm or tripFormSubmitHandler)
        // Add this call in your validateForm function:
        // validateHolidayHoursInput();

        // --- White/Purple Flag UI Logic ---
        const whiteFlagToggle = document.getElementById('white-flag');
        const whiteFlagLabel = document.getElementById('white-flag-label');
        const purpleFlagToggle = document.getElementById('purple-flag');
        const purpleFlagLabel = document.getElementById('purple-flag-label');
        const purpleFlagDropdownGroup = document.getElementById('purple-flag-dropdown-group');
        const purpleFlagPremiumSelect = document.getElementById('purple-flag-premium');

        function updateToggleLabel(toggle, labelElement) {
          labelElement.textContent = toggle.checked ? 'Yes' : 'No';
          const toggleSlider = toggle.nextElementSibling;
          if (toggleSlider && toggleSlider.hasAttribute('aria-checked')) {
            toggleSlider.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
          }
        }

        purpleFlagToggle.addEventListener('change', function() {
          updateToggleLabel(purpleFlagToggle, purpleFlagLabel);
          purpleFlagDropdownGroup.style.display = purpleFlagToggle.checked ? 'block' : 'none';
        });
        whiteFlagToggle.addEventListener('change', function() {
          updateToggleLabel(whiteFlagToggle, whiteFlagLabel);
        });
        // On page load, set initial state
        updateToggleLabel(whiteFlagToggle, whiteFlagLabel);
        updateToggleLabel(purpleFlagToggle, purpleFlagLabel);
        purpleFlagDropdownGroup.style.display = purpleFlagToggle.checked ? 'block' : 'none';

        // --- Calculation Logic for Premiums ---
        function getFlagPremiumMultiplier() {
          let premiumMultiplier = 1;
          if (whiteFlagToggle.checked) {
            premiumMultiplier *= 1.5;
          }
          if (purpleFlagToggle.checked) {
            const purplePremium = parseFloat(purpleFlagPremiumSelect.value) || 1;
            premiumMultiplier *= purplePremium;
          }
          return premiumMultiplier;
        }
        // Usage: let payWithPremium = basePay * getFlagPremiumMultiplier();
    </script>
</body>
</html>
